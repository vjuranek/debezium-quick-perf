= Debezium Quick Performance Tests

== Preparation

=== DBZ app

* compile app:

`mvn clean package -f dbz-app/pom.xml`

* create directiry for storing offset:

`mkdir data`

=== Postgres

* Start DB container:

`podman run --rm --name postgres -it -e POSTGRES_PASSWORD=postgres -p 5432:5432 quay.io/debezium/example-postgres:3.2`

* Prepare tables for `pgbench`:

`PGPASSWORD=postgres pgbench -h 127.0.0.1 -U postgres -i postgres --scale=10`

== Running the test

* run `pgbench`:

`PGPASSWORD=postgres pgbench -h 127.0.0.1 -U postgres --scale=10 -b simple-update --jobs=20 --client=20 -T 120 postgres`

* run `dbz-app` with Flight Recorder enabled:

`java -XX:+FlightRecorder -XX:StartFlightRecording=delay=30s,duration=60s,filename=dbz-flight.jfr,settings=profile -jar dbz-app/target/debezium-quick-perf-1.0-SNAPSHOT.jar`

* stop the application and eventually also `pgbench`

== Analyzing the results

You can analyze the results using tools like Java Mission Control.
Please note possible issue with displaying flame graphs on systems using link:https://wayland.freedesktop.org/[Wayland].
See link:https://bugs.openjdk.org/browse/JMC-8247[JMC-8247].

The flame graph gives us quick overview of the whole run:

image::img/flame_graph_postgres_before.png[]

You can check it in `Method profiling` view:

image::img/method_profiling.png[]

== Proposing fix

=== JMH benchmark

Before:

```
Iteration   1: 0.768 us/op
Iteration   2: 0.774 us/op
Iteration   3: 0.776 us/op
Iteration   4: 0.764 us/op
Iteration   5: 0.767 us/op
Iteration   6: 0.766 us/op
Iteration   7: 0.785 us/op
Iteration   8: 0.782 us/op
Iteration   9: 0.766 us/op
Iteration  10: 0.773 us/op

Benchmark                                Mode  Cnt  Score   Error  Units
PostgresTypeMetadataPerf.columnMetadata  avgt   10  0.772 ? 0.011  us/op

```


After:

```
Iteration   1: 0.054 us/op
Iteration   2: 0.054 us/op
Iteration   3: 0.054 us/op
Iteration   4: 0.053 us/op
Iteration   5: 0.053 us/op
Iteration   6: 0.053 us/op
Iteration   7: 0.054 us/op
Iteration   8: 0.054 us/op
Iteration   9: 0.054 us/op
Iteration  10: 0.054 us/op

Benchmark                                Mode  Cnt  Score    Error  Units
PostgresTypeMetadataPerf.columnMetadata  avgt   10  0.054 ?  0.001  us/op
```

image::img/flame_graph_postgres_after.png[]
